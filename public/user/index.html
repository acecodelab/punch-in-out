<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Nxtgen Virtue</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Custom CSS -->
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
            margin: 0;
        }

        label {
            display: block;
            margin-bottom: 10px;
        }

        input[type="text"],
        button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }

        #outer {
            width: 100%;
            text-align: center;
        }

        .inner {
            display: inline-block;
            margin-left: 5px;
        }

        button {
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background-color: #DD3333;
            color: white;
        }

        .card-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .btn-login {
            width: 100%;
            font-size: 18px;
            background-color: #DD3333;
        }

        .btn {
            margin-right: 10px;
        }

        #punchList li {
            list-style: none;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        }

        #punchList li:hover {
            background-color: #e9ecef;
        }

        .punch-time {
            font-size: 14px;
            color: #6c757d;
        }

        .punch-type {
            font-size: 16px;
            font-weight: bold;
        }

        #totalOutTime {
            font-size: 18px;
        }

        .pagination {
            margin-top: 20px;
            justify-content: center;
        }

        .pagination li {
            display: inline-block;
            margin-right: 5px;
        }

        .pagination a {
            color: #007bff;
            padding: 5px 10px;
            border: 1px solid #007bff;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .pagination a:hover {
            background-color: #007bff;
            color: white;
        }

        .pagination .active a {
            background-color: #007bff;
            color: white;
        }

        .center {
            max-width: fit-content;
            margin-left: auto;
            margin-right: auto;
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h1 class="text-center">Nxtgen Virtue</h1>
            </div>
        </div>

        <div class="card-body">
            <!-- User Login Form -->

            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary btn-login">Login</button>
                <div class="center">
                    <centre>
                        <p>Â© 2024 Nxtgen Virtue All rights reserved.</p>
                    </centre>
                </div>
            </form>
            <!-- User Basic Details -->
            <div style="display: none;" id="details">
                <div id="action_button_div">
                    <div class="btn-group mb-3 d-flex justify-content-center inner" role="group"
                        aria-label="Filter options">
                        <div id="outer">
                            <button type="button" class="inner btn-primary"
                                style="margin-bottom: 10px; float: right;background-color: #6c757d;"
                                onclick="clearLocalStorage()">Logout</button>
                            <button type="button" class=" inner btn-primary"
                                style="margin-bottom: 10px; float: right;background-color: #6c757d;"
                                onclick="changePassword()"> Password</button>
                            <button type="button" class=" inner btn-primary"
                                style="margin-bottom: 10px; float: right;background-color: #6c757d;"
                                onclick="leaveManagement()">Leaves</button>
                        </div>
                    </div>
                </div>
                <div>
                    <b>
                        <p id="details_name"></p>
                    </b>
                </div>

                <div id="filter_button_div">
                    <!-- Buttons for Filter Options -->
                    <div class="btn-group mb-3 d-flex justify-content-center inner" role="group"
                        aria-label="Filter options">
                        <button id="btnToday" type="button" class="btn btn-primary filter-btn"
                            style="display: block;">Today's
                            Reports</button>
                        <button id="btnThisMonth" type="button" class="btn btn-primary filter-btn"
                            style="display: block;">
                            Month's Report</button>
                        <button id="btnBetweenDates" type="button" class="btn btn-primary filter-btn"
                            style="display: block;">
                            Report b/w Dates</button>
                    </div>
                    <!-- Date Range Form (Hidden by default) -->
                    <form id="dateRangeForm" class="form-inline mb-3 justify-content-center" style="display: none;">
                        <div class="form-group mr-2">
                            <label for="startDate" class="mr-2">Start Date:</label>
                            <input type="date" id="startDate" class="form-control" required>
                        </div>
                        <div class="form-group mr-2">
                            <label for="endDate" class="mr-2">End Date:</label>
                            <input type="date" id="endDate" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Get Reports</button>
                    </form>
                </div>
                <div id="p_change_div" style="display: none;">
                    <form id="myForm">
                        <label for="name">Current Password:</label>
                        <input type="text" id="c_password" name="c_password">

                        <label for="email">New Password:</label>
                        <input type="text" id="n_password" name="n_password">
                        <br><br>
                        <button type="button" onclick="savePassword()">Update</button>
                        <button type="button" onclick="cancelPasswordChange()">Cancel</button>
                    </form>
                </div>

            </div>


            <div id="main_div">
                <!-- Punch In Form - Initially Hidden -->
                <form id="punchInForm" style="display: none;">
                    <button type="submit" class="btn btn-primary btn-block">Punch In</button>
                </form>

                <!-- Punch Out Form - Initially Hidden -->
                <form id="punchOutForm" style="display: none;">
                    <button type="submit" class="btn btn-danger btn-block">Punch Out</button>
                </form>

                <!-- Punch History -->
                <div class="card-body" id="punch_history" style="display: none;">
                    <!-- Punch History -->
                    <h3>Punch History</h3>
                    <ul id="punchList" class="list-group"></ul>
                    <div id="total_time_till_now"></div>
                    <div id="totalOutTime"></div>
                    <div id="countdown" style="margin-bottom: 10px;"></div>
                    <!-- Pagination -->
                    <nav>
                        <ul id="pagination" class="pagination justify-content-center"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>




    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>

        const loginForm = document.getElementById('loginForm');
        const punchInForm = document.getElementById('punchInForm');
        const punchOutForm = document.getElementById('punchOutForm');
        const punchList = document.getElementById('punchList');
        const pagination = document.getElementById('pagination');
        const totalOutTimeDiv = document.getElementById('totalOutTime');
        const details = document.getElementById('details');
        const details_name = document.getElementById('details_name');
        const punch_history = document.getElementById('punch_history');
        const countdownElement = document.getElementById('countdown');
        let userId = '';
        let username = '';
        let name = '';
        let email = '';
        var dummyPunchHistory = [];
        var dummyPunchHistoryMonth = [];
        window.onload = function () {
            userId = localStorage.getItem('userId');
            name = localStorage.getItem('name');
            username = localStorage.getItem('username');
            email = localStorage.getItem('email');
            checkecived()
        };
        async function checkecived() {
            if (localStorage.getItem('ecived') == 'm') {
                if (userId && name && username && email) {
                    punchInForm.style.display = 'none'
                    punchOutForm.style.display = 'none'
                    showDashboard('m');
                }
            }
            else if (localStorage.getItem('ecived') == 'd') {
                if (userId && name && username && email) {
                    showDashboard('d');
                }
            }
            else {
                if (/Mobi/.test(navigator.userAgent)) {
                    localStorage.setItem('ecived', 'm');
                    if (userId && name && username && email) {
                        showDashboard('d');
                        punchInForm.style.display = 'none'
                        punchOutForm.style.display = 'none'
                    }
                }
                else {
                    localStorage.setItem('ecived', 'd');
                    if (userId && name && username && email) {
                        showDashboard('d');
                        punchInForm.style.display = 'block'
                        punchOutForm.style.display = 'block'

                    }
                }
            }
        }
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const enteredUsername = loginForm.username.value.trim();
            const enteredPassword = loginForm.password.value.trim();

            // Perform basic client-side validation (replace with backend validation)
            if (!enteredUsername || !enteredPassword) {
                alert('Please enter Username and Password');
                return;
            }

            // Perform backend authentication (replace with backend API call)
            const response = await fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username: enteredUsername, password: enteredPassword })
            });

            const result = await response.json();
            if (result.success) {
                userId = result.user_id;
                name = result.name;
                username = result.username;
                email = result.email;

                localStorage.setItem('userId', userId);
                localStorage.setItem('name', name);
                localStorage.setItem('username', username);
                localStorage.setItem('email', email);
                loginForm.reset();
                checkecived();
            } else {
                if (result.msg) {
                    alert(result.msg)
                }
                else {
                    alert('Invalid Username or Password');
                }
            }
        });

        async function showDashboard(type) {
            loginForm.style.display = 'none';
            details.style.display = 'block'
            details_name.innerText = 'Name :- ' + name
            punch_history.style.display = 'block'
            await fetchPunchHistory(userId, type);
        }

        punchInForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            await submitPunch(userId, 'in', email);
        });

        punchOutForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            await submitPunch(userId, 'out', email);
        });

        async function submitPunch(userId, type, email) {
            const response = await fetch(`/punch/${type}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: userId, email: email })
            });

            const result = await response.json();

            if (result.success && result.error == null) {
                if (type === 'in') {
                    hasPunchedIn = true; // Set flag to true after punch in
                    punchInForm.style.display = 'none'; // Hide Punch In form
                    punchOutForm.style.display = 'block'; // Show Punch Out form
                } else {
                    hasPunchedIn = false; // Set flag to false after punch out
                    punchInForm.style.display = 'block'; // Show Punch In form
                    punchOutForm.style.display = 'none'; // Hide Punch Out form
                }
                await fetchPunchHistory(userId);
            } else if (result.success && result.error != null) {
                if (type === 'in') {
                    hasPunchedIn = true; // Set flag to true after punch in
                    punchInForm.style.display = 'none'; // Hide Punch In form
                    punchOutForm.style.display = 'block'; // Show Punch Out form
                } else {
                    hasPunchedIn = false; // Set flag to false after punch out
                    punchInForm.style.display = 'block'; // Show Punch In form
                    punchOutForm.style.display = 'none'; // Hide Punch Out form
                }
                await fetchPunchHistory(userId);
                alert(result.error);
            } else {
                alert('Error: ' + result.error);
            }
        }

        async function fetchPunchHistory(userId, type) {
            if (type == 'm') {
                return;
            }
            const response = await fetch(`/punches/${userId}`);
            const result = await response.json();

            if (result.success) {
                dummyPunchHistory = []
                dummyPunchHistoryMonth = []
                var punches = result.data.punches
                var monthPunches = result.data.punchesMonth
                punches.forEach(punch => {
                    dummyPunchHistory.push({ punch_type: punch.punch_type.toUpperCase(), timestamp: punch.timestamp })
                });
                monthPunches.forEach(punch => {
                    dummyPunchHistoryMonth.push({ punch_type: punch.punch_type.toUpperCase(), timestamp: punch.timestamp })
                });
                if (dummyPunchHistory.length == 0) {
                    punchInForm.style.display = 'block';
                    punchOutForm.style.display = 'none';
                }
                else {
                    if (dummyPunchHistory[0].punch_type == 'IN') {
                        punchInForm.style.display = 'none';
                        punchOutForm.style.display = 'block';
                    }
                    else if (dummyPunchHistory[0].punch_type == 'OUT') {
                        punchInForm.style.display = 'block';
                        punchOutForm.style.display = 'none';
                    }
                }
                renderPunchHistory(dummyPunchHistory, 1);
                renderTotalOutTime(dummyPunchHistory, 'today');
                renderTotalOutTime(dummyPunchHistoryMonth, 'month');
            } else {
                alert('Error: ' + result.error);
            }
        }

        function renderPunchHistory(punches, page = 1, pageSize = 4) {
            const startIndex = (page - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, punches.length);

            const paginatedPunches = punches.slice(startIndex, endIndex);

            punchList.innerHTML = '';
            paginatedPunches.forEach(punch => {
                const li = document.createElement('li');
                li.classList.add('list-group-item');

                const time = new Date(punch.timestamp).toLocaleString();
                li.innerHTML = `<span class="punch-time">${time}</span> - <span class="punch-type">${punch.punch_type}</span>`;

                punchList.appendChild(li);
            });

            // Update pagination
            const totalPages = Math.ceil(punches.length / pageSize);
            renderPagination(totalPages, page);
        }
        // Function to render pagination
        function renderPagination(totalPages, currentPage) {
            pagination.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.classList.add('page-item');
                if (i === currentPage) {
                    li.classList.add('active');
                }

                const link = document.createElement('a');
                link.classList.add('page-link');
                link.href = '#';
                link.textContent = i;
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    renderPunchHistory(dummyPunchHistory, i);
                });

                li.appendChild(link);
                pagination.appendChild(li);
            }
        }

        function renderTotalOutTime(punches, type) {
            let totalMilliseconds = 0;
            let lastInTime = null;
            var reverse_punch = punches.reverse();
            //punches.reverse();
            reverse_punch.forEach(punch => {
                if (punch.punch_type === 'IN') {
                    lastInTime = new Date(punch.timestamp).getTime();
                } else if (punch.punch_type === 'OUT' && lastInTime !== null) {
                    const outTime = new Date(punch.timestamp).getTime();
                    const duration = outTime - lastInTime;
                    totalMilliseconds += duration;

                    // Display individual duration
                    const durationSeconds = Math.floor(duration / 1000);
                    const durationFormatted = formatDuration(durationSeconds);
                    lastInTime = null;
                }
            });

            const totalSeconds = totalMilliseconds / 1000;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            if (type == 'today') {
                totalOutTimeDiv.textContent = `Today working hours: ${hours}h ${minutes}m ${seconds}s`;
            }
            else if (type == 'month') {
                document.getElementById("total_time_till_now").textContent = `Month working hours: ${hours}h ${minutes}m ${seconds}s`
                document.getElementById("total_time_till_now").style.color = 'red';
            }
            if (hours <= 7) {
                if (minutes >= 30) {
                    if (type == 'today') {
                        totalOutTimeDiv.style.color = 'red';
                    }
                }
                else {
                    if (type == 'today') {
                        totalOutTimeDiv.style.color = 'green';
                    }
                }
            }
            else {
                if (type == 'today') {
                    totalOutTimeDiv.style.color = 'green';
                }
            }
            punches.reverse();
        }

        function formatDuration(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);

            return `${hours}h ${minutes}m ${seconds}s`;
        }

        function clearLocalStorage() {
            localStorage.removeItem('userId');
            localStorage.removeItem('name');
            localStorage.removeItem('username');
            localStorage.removeItem('email');
            localStorage.removeItem('ecived');
            alert('Logout successfully!');
            window.location.reload();
        }

        function changePassword() {
            document.getElementById("p_change_div").style.display = 'block'
            document.getElementById("main_div").style.display = 'none'
            document.getElementById("filter_button_div").style.display = 'none'
        }

        function cancelPasswordChange() {
            document.getElementById("p_change_div").style.display = 'none'
            document.getElementById("main_div").style.display = 'block'
            document.getElementById("filter_button_div").style.display = 'block'
        }

        function leaveManagement() {
            window.location.href = "/user/leave.html";
        }
        async function savePassword() {
            var c_password = document.getElementById("c_password").value;
            var n_password = document.getElementById("n_password").value;

            const response = await fetch(`/updatePassword/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ c_password: c_password, n_password: n_password, userId: userId })
            });

            const result = await response.json();
            if (result.status) {
                alert('Password changed successfully')
                window.location.reload();

            }
            else {
                alert('Unable to update password')
            }
        }

        function fetchReports(filterType, userId, startDate, endDate) {
            let url = `/reports/${filterType}?userId=${userId}`;
            if (filterType === 'between-dates') {
                url += `&startDate=${startDate}&endDate=${endDate}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const reports = data.reports;
                    dummyPunchHistory = []
                    reports.forEach(report => {
                        dummyPunchHistory.push({ punch_type: report.punch_type.toUpperCase(), timestamp: report.timestamp })
                    });

                    renderPunchHistory(dummyPunchHistory, 1);
                    renderTotalOutTime(dummyPunchHistory, 'today');

                })
                .catch(error => console.error('Error fetching reports:', error));
        }

        // Button Event Listeners
        document.getElementById('btnToday').addEventListener('click', () => {
            document.getElementById('dateRangeForm').style.display = 'none';
            document.getElementById('time_req').style.display = 'block';
            fetchReports('today', userId);
        });

        document.getElementById('btnThisMonth').addEventListener('click', () => {
            document.getElementById('dateRangeForm').style.display = 'none';
            document.getElementById('time_req').style.display = 'none';
            fetchReports('this-month', userId);
        });

        document.getElementById('btnBetweenDates').addEventListener('click', () => {
            document.getElementById('dateRangeForm').style.display = 'block';
            document.getElementById('time_req').style.display = 'none';
        });

        // Form Submission for Reports Between Dates
        document.getElementById('dateRangeForm').addEventListener('submit', (event) => {
            event.preventDefault();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            fetchReports('between-dates', userId, startDate, endDate);
        });

        // Set the target time for the countdown (9:30 AM and 6:30 PM)

        const targetTimes = [
            { hour: 9, minute: 30 },
            { hour: 19, minute: 0 }
        ];
        // Function to calculate remaining time
        function calculateTimeRemaining() {
            const now = new Date();
            let targetTime;
            // Set the target time to 6:30 PM if current time is past 9:30 AM, else set it to 9:30 AM
            if (now.getHours() < 9 || (now.getHours() === 9 && now.getMinutes() < 30)) {
                targetTime = new Date(now);
                targetTime.setHours(targetTimes[0].hour);
                targetTime.setMinutes(targetTimes[0].minute);
            } else {
                targetTime = new Date(now);
                targetTime.setHours(targetTimes[1].hour);
                targetTime.setMinutes(targetTimes[1].minute);
            }

            const totalSeconds = Math.floor((targetTime - now) / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);

            return { hours, minutes, seconds };
        }

        // Function to update the countdown display
        function updateCountdown() {
            const { hours, minutes, seconds } = calculateTimeRemaining();
            countdownElement.innerHTML = `Time Remaining: ${hours} hours, ${minutes} minutes`;

            // Check if the countdown has reached 0, if so, stop updating
            if (hours === 0 && minutes === 0 && seconds === 0) {
                clearInterval(countdownInterval);
            }
        }

        // Initial call to update countdown display
        updateCountdown();

        // Update countdown display every second
        const countdownInterval = setInterval(updateCountdown, 1000);

    </script>
</body>

</html>