<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nxtgen Virtue</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Custom CSS -->
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background-color: #DD3333;
            color: white;
        }

        .card-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .btn-login {
            width: 100%;
            font-size: 18px;
            background-color: #DD3333;
        }

        #punchList li {
            list-style: none;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        }

        #punchList li:hover {
            background-color: #e9ecef;
        }

        .punch-time {
            font-size: 14px;
            color: #6c757d;
        }

        .punch-type {
            font-size: 16px;
            font-weight: bold;
        }

        #totalOutTime {
            margin-top: 20px;
            font-size: 18px;
        }

        .pagination {
            margin-top: 20px;
            justify-content: center;
        }

        .pagination li {
            display: inline-block;
            margin-right: 5px;
        }

        .pagination a {
            color: #007bff;
            padding: 5px 10px;
            border: 1px solid #007bff;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .pagination a:hover {
            background-color: #007bff;
            color: white;
        }

        .pagination .active a {
            background-color: #007bff;
            color: white;
        }

        .center {
            max-width: fit-content;
            margin-left: auto;
            margin-right: auto;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h1 class="text-center">Nxtgen Virtue</h1>
            </div>
            <div class="card-body">
                <!-- User Login Form -->
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-login">Login</button>
                    <div class="center">
                        <centre>
                            <p>Â© 2024 Nxtgen Virtue All rights reserved.</p>
                        </centre>
                    </div>
                </form>

                <!-- User Basic Details -->
                <div style="display: none;" id="details">
                    <div>
                        <p id="details_name"></p>
                    </div>
                    <div>
                        <button type="button" class="btn btn-primary" style="margin-bottom: 10px; float: right;"
                            onclick="clearLocalStorage()">Logout</button>
                    </div>
                </div>

                <!-- Punch In Form - Initially Hidden -->
                <form id="punchInForm" style="display: none;">
                    <button type="submit" class="btn btn-primary btn-block">Punch In</button>
                </form>

                <!-- Punch Out Form - Initially Hidden -->
                <form id="punchOutForm" style="display: none;">
                    <button type="submit" class="btn btn-danger btn-block">Punch Out</button>
                </form>

                <!-- Punch History -->
                <div class="card-body" id="punch_history" style="display: none;">
                    <!-- Punch History -->
                    <h3>Punch History</h3>
                    <ul id="punchList" class="list-group"></ul>
                    <div id="totalOutTime"></div>
                    <!-- Pagination -->
                    <nav>
                        <ul id="pagination" class="pagination justify-content-center"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>


    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        // JavaScript
        // JavaScript
        const loginForm = document.getElementById('loginForm');
        const punchInForm = document.getElementById('punchInForm');
        const punchOutForm = document.getElementById('punchOutForm');
        const punchList = document.getElementById('punchList');
        const pagination = document.getElementById('pagination');
        const totalOutTimeDiv = document.getElementById('totalOutTime');
        const details = document.getElementById('details');
        const details_name = document.getElementById('details_name');
        const punch_history = document.getElementById('punch_history');
        let userId = '';
        let username = '';
        let name = '';
        let email = '';
        var dummyPunchHistory = [];

        window.onload = function () {
            userId = localStorage.getItem('userId');
            name = localStorage.getItem('name');
            username = localStorage.getItem('username');
            email = localStorage.getItem('email');

            if (userId && name && username && email) {
                showDashboard();
            }
        };


        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const enteredUsername = loginForm.username.value.trim();
            const enteredPassword = loginForm.password.value.trim();

            // Perform basic client-side validation (replace with backend validation)
            if (!enteredUsername || !enteredPassword) {
                alert('Please enter Username and Password');
                return;
            }

            // Perform backend authentication (replace with backend API call)
            const response = await fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username: enteredUsername, password: enteredPassword })
            });

            const result = await response.json();
            if (result.success) {
                userId = result.user_id;
                name = result.name;
                username = result.username;
                email = result.email;

                localStorage.setItem('userId', userId);
                localStorage.setItem('name', name);
                localStorage.setItem('username', username);
                localStorage.setItem('email', email);

                loginForm.reset();
                showDashboard();
            } else {
                if (result.msg) {
                    alert(result.msg)
                }
                else {
                    alert('Invalid Username or Password');
                }
            }
        });

        async function showDashboard() {
            loginForm.style.display = 'none';
            details.style.display = 'block'
            details_name.innerText = 'Name :- ' + name
            punch_history.style.display = 'block'
            await fetchPunchHistory(userId);
        }

        punchInForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            await submitPunch(userId, 'in', email);
        });

        punchOutForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            await submitPunch(userId, 'out', email);
        });

        async function submitPunch(userId, type, email) {
            const response = await fetch(`/punch/${type}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: userId, email: email })
            });

            const result = await response.json();

            if (result.success && result.error == null) {
                if (type === 'in') {
                    hasPunchedIn = true; // Set flag to true after punch in
                    punchInForm.style.display = 'none'; // Hide Punch In form
                    punchOutForm.style.display = 'block'; // Show Punch Out form
                } else {
                    hasPunchedIn = false; // Set flag to false after punch out
                    punchInForm.style.display = 'block'; // Show Punch In form
                    punchOutForm.style.display = 'none'; // Hide Punch Out form
                }
                await fetchPunchHistory(userId);
            } else if (result.success && result.error != null) {
                if (type === 'in') {
                    hasPunchedIn = true; // Set flag to true after punch in
                    punchInForm.style.display = 'none'; // Hide Punch In form
                    punchOutForm.style.display = 'block'; // Show Punch Out form
                } else {
                    hasPunchedIn = false; // Set flag to false after punch out
                    punchInForm.style.display = 'block'; // Show Punch In form
                    punchOutForm.style.display = 'none'; // Hide Punch Out form
                }
                await fetchPunchHistory(userId);
                alert(result.error);
            } else {
                alert('Error: ' + result.error);
            }
        }

        async function fetchPunchHistory(userId) {
            const response = await fetch(`/punches/${userId}`);
            const result = await response.json();

            if (result.success) {
                dummyPunchHistory = []
                var punches = result.data.punches
                punches.forEach(punch => {
                    dummyPunchHistory.push({ punch_type: punch.punch_type.toUpperCase(), timestamp: punch.timestamp })
                });
                if (dummyPunchHistory.length == 0) {
                    punchInForm.style.display = 'block';
                    punchOutForm.style.display = 'none';
                }
                else {
                    if (dummyPunchHistory[0].punch_type == 'IN') {
                        punchInForm.style.display = 'none';
                        punchOutForm.style.display = 'block';
                    }
                    else if (dummyPunchHistory[0].punch_type == 'OUT') {
                        punchInForm.style.display = 'block';
                        punchOutForm.style.display = 'none';
                    }
                }
                renderPunchHistory(dummyPunchHistory, 1);
                renderTotalOutTime(dummyPunchHistory);
            } else {
                alert('Error: ' + result.error);
            }
        }

        function renderPunchHistory(punches, page = 1, pageSize = 4) {
            const startIndex = (page - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, punches.length);

            const paginatedPunches = punches.slice(startIndex, endIndex);

            punchList.innerHTML = '';
            paginatedPunches.forEach(punch => {
                const li = document.createElement('li');
                li.classList.add('list-group-item');

                const time = new Date(punch.timestamp).toLocaleString();
                li.innerHTML = `<span class="punch-time">${time}</span> - <span class="punch-type">${punch.punch_type}</span>`;

                punchList.appendChild(li);
            });

            // Update pagination
            const totalPages = Math.ceil(punches.length / pageSize);
            renderPagination(totalPages, page);
        }
        // Function to render pagination
        function renderPagination(totalPages, currentPage) {
            pagination.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.classList.add('page-item');
                if (i === currentPage) {
                    li.classList.add('active');
                }

                const link = document.createElement('a');
                link.classList.add('page-link');
                link.href = '#';
                link.textContent = i;
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    renderPunchHistory(dummyPunchHistory, i);
                });

                li.appendChild(link);
                pagination.appendChild(li);
            }
        }

        function renderTotalOutTime(punches) {
            let totalMilliseconds = 0;
            let lastInTime = null;
            var reverse_punch = punches.reverse();
            //punches.reverse();
            reverse_punch.forEach(punch => {
                if (punch.punch_type === 'IN') {
                    lastInTime = new Date(punch.timestamp).getTime();
                } else if (punch.punch_type === 'OUT' && lastInTime !== null) {
                    const outTime = new Date(punch.timestamp).getTime();
                    const duration = outTime - lastInTime;
                    totalMilliseconds += duration;

                    // Display individual duration
                    const durationSeconds = Math.floor(duration / 1000);
                    const durationFormatted = formatDuration(durationSeconds);
                    lastInTime = null;
                }
            });

            const totalSeconds = totalMilliseconds / 1000;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            totalOutTimeDiv.textContent = `Total Out Time: ${hours}h ${minutes}m ${seconds}s`;
            punches.reverse();
        }

        function formatDuration(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);

            return `${hours}h ${minutes}m ${seconds}s`;
        }

        function clearLocalStorage() {
            localStorage.removeItem('userId');
            localStorage.removeItem('name');
            localStorage.removeItem('username');
            localStorage.removeItem('email');
            alert('Logout successfully!');
            window.location.reload();
        }
    </script>
</body>

</html>